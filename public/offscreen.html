<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>CleanClip Offscreen Clipboard</title>
</head>
<body>
<script>
console.log('[Offscreen] Script started!');

const CLIPBOARD_REQUEST_KEY = '__CLEANCLIP_CLIPBOARD_REQUEST__';
const CLIPBOARD_RESPONSE_KEY = '__CLEANCLIP_CLIPBOARD_RESPONSE__';

async function handleClipboardWrite(text, customMimeTypes) {
  console.log('[Offscreen] handleClipboardWrite called, text length:', text.length);

  try {
    const tempDiv = document.createElement('div');
    tempDiv.style.cssText = 'position:fixed;left:-9999px;';
    tempDiv.textContent = text;
    document.body.appendChild(tempDiv);

    const selection = window.getSelection();
    const range = document.createRange();
    range.selectNodeContents(tempDiv);
    selection.removeAllRanges();
    selection.addRange(range);

    let copySuccessful = false;

    const copyHandler = (e) => {
      console.log('[Offscreen] Copy event fired!');
      e.preventDefault();
      e.clipboardData.setData('text/plain', text);

      if (customMimeTypes && customMimeTypes.length > 0) {
        customMimeTypes.forEach(({ mimeType, data }) => {
          e.clipboardData.setData(mimeType, data);
          console.log('[Offscreen] Set MIME type:', mimeType);
        });
      }
      copySuccessful = true;
    };

    document.addEventListener('copy', copyHandler, { once: true });
    const successful = document.execCommand('copy');

    document.body.removeChild(tempDiv);
    selection.removeAllRanges();

    console.log('[Offscreen] execCommand result:', successful, 'copySuccessful:', copySuccessful);

    if (successful && copySuccessful) {
      return { success: true, timestamp: 0 };
    } else {
      return { success: false, error: 'Copy operation failed', timestamp: 0 };
    }
  } catch (error) {
    console.error('[Offscreen] Clipboard write failed:', error);
    return { success: false, error: error.message, timestamp: 0 };
  }
}

async function processClipboardWriteRequest(request) {
  console.log('[Offscreen] Processing request, timestamp:', request.timestamp);
  const result = await handleClipboardWrite(request.text, request.customMimeTypes);

  const responseData = {
    ...result,
    timestamp: request.timestamp
  };

  console.log('[Offscreen] Writing response to storage');
  await chrome.storage.local.set({ [CLIPBOARD_RESPONSE_KEY]: responseData });
  console.log('[Offscreen] Response written!');
}

function setupStorageListener() {
  console.log('[Offscreen] Setting up storage listener');
  chrome.storage.onChanged.addListener((changes, areaName) => {
    console.log('[Offscreen] Storage changed:', areaName, Object.keys(changes));
    if (areaName === 'local' && changes[CLIPBOARD_REQUEST_KEY]?.newValue) {
      console.log('[Offscreen] Clipboard request detected!');
      processClipboardWriteRequest(changes[CLIPBOARD_REQUEST_KEY].newValue);
    }
  });
  console.log('[Offscreen] Storage listener registered');
}

setupStorageListener();
console.log('[Offscreen] Initialization complete!');

// Write to storage to confirm script is running
chrome.storage.local.set({ '__OFFSCREEN_LOADED__': Date.now() }).then(() => {
  console.log('[Offscreen] Wrote load confirmation to storage');
});
</script>
</body>
</html>
